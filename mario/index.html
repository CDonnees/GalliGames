<!doctype html> 
<html lang="en"> 
	<head> 
			<meta charset="UTF-8" />
				<title>Phaser - Making your first game, part 1</title>
					<script type="text/javascript" src="phaser.js"></script>
					    <style type="text/css">
        body {
					            margin: 0;
												        }
				    </style>
	
	
	
		<!-- polyfill -->
	<script src="/inc/shim/Base64.js" type="text/javascript"></script>
	<script src="/inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="/js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="/js/midi/gm.js" type="text/javascript"></script>
	<script src="/js/midi/loader.js" type="text/javascript"></script>
	<script src="/js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="/js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="/js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="/js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="/js/util/dom_request_script.js" type="text/javascript"></script>
	
	
	</head>
	<body>

	<script type="text/javascript">
	window.onload = function () {
	MIDI.loadPlugin({
		soundfontUrl: "./soundfont/",
		instrument: "acoustic_grand_piano",
		onprogress: function(state, progress) {
			console.log(state, progress);
		},
		onsuccess: function() {
		}
	});
	};
	</script>

	<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function play(){
			var delay = 0; // play one note every quarter second
			var note = 50; // the MIDI note
			var velocity = 127; // how hard the note hits
			// play the note
			MIDI.setVolume(0, 127);
			MIDI.noteOn(0, note, velocity, delay);
			MIDI.noteOff(0, note, delay + 0.75);
}

function preload() {
	    game.load.image('sky', 'assets/sky.png');
			game.load.image('ground', 'assets/platform.png');
			game.load.image('star', 'assets/star.png');
			game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
	
			game.load.json('level', 'level2.json');

}

function create() {
  game.physics.startSystem(Phaser.Physics.ARCADE);
	var ReallyLargeWidth = 99999;

	game.world.setBounds(0, 0, ReallyLargeWidth, 600);

	game.add.tileSprite(0, 0, ReallyLargeWidth, 600, 'sky');

	levelJSON = game.cache.getJSON('level');

  platforms = game.add.group();
  platforms.enableBody = true;

  var ground = platforms.create(0, game.world.height - 64, 'ground');
  ground.scale.setTo(2, 2);
  ground.body.immovable = true;

	// console.log(levelJSON)

	notes = game.add.group();

	for (var k in levelJSON){
		var track = levelJSON[k];
		var cursor = 0;

		for (var n in track){
			let note = track[n];
	
			cursor += note.tick;

			var x = cursor;
			var y = parseInt(k)*24;

			// game.add.sprite(x, y,'star')
			var n = notes.create(x, y, 'star');
			//n.body.immovable=true;
		}
	}
	player = game.add.sprite(0, 0, 'dude');

	//  We need to enable physics on the player
	game.physics.enable(player, Phaser.Physics.ARCADE);

	//  Player physics properties. Give the little guy a slight bounce.
	player.body.bounce.y = 0.2;
	player.body.gravity.y = 300;
	player.body.collideWorldBounds = true;
	player.body.checkCollision.down = true;

	//  Our two animations, walking left and right.
	player.animations.add('left', [0, 1, 2, 3], 10, true);
	player.animations.add('right', [5, 6, 7, 8], 10, true);

  game.camera.follow(player);

	cursors = game.input.keyboard.createCursorKeys();
}

function play_note(){
	//play();
}

function check_partition(){
	x = player.body.x;

	// console.log(x);


	for (var t in levelJSON){
		var track = levelJSON[t];

		var cursor = 0;

		for (var i in track){
			let note = track[i];
		
			cursor += note.tick;

			if (note.type == "Note On" && x < cursor + 2 && x > cursor - 2){
				var pitch = note.pitch; // the MIDI note
				var velocity = 127; // how hard the note hits
				// play the note
				MIDI.noteOn(0, pitch, velocity, 0);
				// console.log(cursor);
				MIDI.noteOff(0, pitch, track[String(parseInt(i)+1)].tick);
			}
		}
	}
}

function update() {
    var hitPlatform = game.physics.arcade.collide(player, platforms, play_note)
		game.physics.arcade.collide(player, platforms, check_partition, null, this);

    //  Reset the players velocity (movement)
    player.body.velocity.x = 0;

    if (cursors.left.isDown)
    {   
	 			//  Move to the left
        player.body.velocity.x = -250;

        player.animations.play('left');
    }
    else if (cursors.right.isDown)
    {
        //  Move to the right
        player.body.velocity.x = 250;

        player.animations.play('right');
  
				check_partition(player.body.x);
		}
    else
    {
        //  Stand still
        player.animations.stop();

        player.frame = 4;
    }

    //  Allow the player to jump if they are touching the ground.
    if (cursors.up.isDown)
    {
        player.body.velocity.y = -250;
    };
}

	</script>

	</body>
</html>
